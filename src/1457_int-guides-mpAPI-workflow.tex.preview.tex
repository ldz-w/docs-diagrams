% Preamble
\documentclass[tikz,border=12pt,12pt]{standalone}
\input{sequence_style.tikz}

\newcommand\multipaymentapi{Multi Payment API}

\begin{document}
\begin{tikzpicture}
  	
    	% Participants
    	\node[pt1] at (-5,1) {Merchant System};
    		\node[inner sep=0pt] (icon1) at (-5,2)
		{\includegraphics[width=.1\textwidth]{retailers.png}};
    	\node[pt2] at (10,1) {\multipaymentapi};
		\node[inner sep=0pt] (icon2) at (10,2)
		{\includegraphics[width=.1\textwidth]{technology.png}};
    	\node[pt3] at (25,1) {Payment Provider};
		\node[inner sep=0pt] (icon3) at (25,2)
		{\includegraphics[width=.1\textwidth]{bigdata.png}};

	% Aid Lines
	\draw[line_mulberry] (-5,0) -- (-5,-19.5);
	\draw[line_night] (10,0) -- (10,-19.5);
	\draw[line_nightsky] (25,0) -- (25,-19.5);
    	
    	% Nodes
    	\fill[mulberry] (-5.1,-.75) rectangle (-4.9,-1.25);
    	\fill[nightsky] (10.1,-0.9) rectangle (9.9,-6.2);
    	\fill[sky] (25.1,-6.0) rectangle (24.9,-10.2);
    	\fill[nightsky] (10.1,-9) rectangle (9.9,-14.8);
    	\fill[mulberry] (-5.1,-17.95) rectangle (-4.9,-18.45);
    	
    	% Arrows & Text
    	\draw[solidarrow]
    		(-4.8,-1) -- node[midway,above] {Multipayment Request} (9.8,-1);
    	\draw[solidarrow, txt]
    		(10.2,-1) -- (10.4,-1) -- node[midway,right] {Validate payment request} (10.4,-2.5) -- (10.2,-2.5);
    	\draw[solidarrow, txt]
    		(10.2,-3) -- (10.4,-3) -- node[midway,right] {Generate single payment request \\ for each payment method} (10.4,-4.5) -- (10.2,-4.5);
    	\draw[solidarrow, txt]
    		(10.2,-6.1) -- node[midway,above] {Send request for single payment method} (24.8,-6.1);
    	\draw[solidarrow, txt]
    		(25.2,-6.1) -- (25.4,-6.1) -- node[midway,right] {Process payment request} (25.4,-7.6) -- (25.2,-7.6);
    	\draw[solidarrow, txt]
    		(25.2,-8.1) -- (25.4,-8.1) -- node[midway,right] {Send payment response} (25.4,-9.6) -- (25.2,-9.6);


      	\draw[solidarrow, txt]
    		(24.8,-9.1) -- node[midway,above] {Payment successful} (10.2,-9.1);
    		
    		
    	\draw[solidarrow, txt]
    		(24.8,-10.1) -- node[midway,above] {Payment failed} (16,-10.1);
    	\draw[gray]
    		(16,-10.1) -- node[midway,right] { } (16,-13.1);
    	\draw[solidarrow, txt]
    		(16,-13.1) -- node[midway,above] {Rollback previously successful \\ payment transaction} (24.8,-13.1);
    	\draw[solidarrow, txt]
    		(25.2,-13.1) -- (25.4,-13.1) -- node[midway,right] {Cancel previous \\ payment transaction} (25.4,-14.6) -- (25.2,-14.6);
    		
    	\draw[solidarrow, txt]
    		(10.2,-13.6) -- (10.4,-13.6) -- node[midway,right] {Pending Payment \\ Request?} (10.4,-15.1) -- (10.2,-15.1);
    	\draw[solidarrow, txt]
    		(9.8,-15) -- (9.6,-15) -- node[midway,left] {1 to n \\ Yes} (9.6,-6.1) -- (9.8,-6.1);
    	\draw[solidarrow, txt]
    		(9.8,-15.2) -- (9.6,-15.2) -- node[midway,left] {No} (9.6,-16.7) -- (9.8,-16.7);
    	\draw[solidarrow, txt]
    		(10.2,-16.7) -- (10.4,-16.7) -- node[midway,right] {Build Response} (10.4,-18.2) -- (10.2,-18.2);
    	\draw[solidarrow, txt]
    		(9.8,-18.2) -- node[midway,above] {Multipayment Response} (-4.8,-18.2);

    		
\end{tikzpicture}
\end{document}

bounding box.south west)+(-\border,-\border) rectangle (current bounding box.north east)+(\border,\border);
\newwrite\metadatafile
\immediate\openout\metadatafile=\jobname_BB.txt
\path
  let
    \p1=(current bounding box.south west),
    \p2=(current bounding box.north east)
  in
  node[inner sep=0pt,outer sep=0pt,minimum size=0pt,line width=0pt,text width=0pt,text height=0pt,draw=white] at (current bounding box) {
\immediate\write\metadatafile{\p1,\p2}
};
\immediate\closeout\metadatafile
\end{tikzpicture}
\end{document}







