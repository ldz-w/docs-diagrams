\documentclass[tikz,border=12pt,12pt]{standalone}
\input{style/new_sequence.tikz}
\input{vars/shortcuts.tex}

\begin{document}
\begin{tikzpicture}
  	
    	\node[merchant] at (0,1.5) {Merchant};
    		\node[inner sep=0pt] (icon1) at (0,3)
		{\includegraphics[width=.1\textwidth]{merchant.png}};
    	\node[paymentgateway] at (10,1.5) {Payment Gateway};
		\node[inner sep=0pt] (icon2) at (10,3)
		{\includegraphics[width=.1\textwidth]{paymentgateway.png}};
    	\node[paymentprovider] at (20,1.5) {Payment Provider};
		\node[inner sep=0pt] (icon3) at (20,3)
		{\includegraphics[width=.1\textwidth]{paymentprovider.png}};

    		\foreach \i in {0,10,20} {
		\draw[aidline] (\i,0) -- (\i,-20);
		}

	\draw[box,mulberryblue] (0,-0.5)-- (0,-1.5);
	\draw[box,bluemulberry] (10,-0.9) -- (10,-6.2);
	\draw[box,mulberrylike] (20,-6) -- (20,-10.7);
	\draw[box,bluemulberry] (10,-9) -- (10,-19.3);
	\draw[box,bluemulberry] (10.4,-10.5) -- (10.4,-13.2);
	\draw[box,mulberrylike] (20,-13) -- (20,-18.8);
	\draw[box,mulberryblue] (0,-18.2)-- (0,-19.2);
    	
    	\draw[solidarrow]
    		(0.2,-1) -- node[midway,above] {Multipayment request} (9.8,-1);
    	\draw[solidarrow, txt]
    		(10.2,-1) -- (10.6,-1) -- node[midway,right] {Validate payment request} (10.6,-2.5) -- (10.2,-2.5);
    	\draw[solidarrow, txt]
    		(10.2,-3) -- (10.6,-3) -- node[midway,right] {Generate single payment request \\ for each payment method} (10.6,-4.5) -- (10.2,-4.5);
    	\draw[solidarrow, txt]
    		(10.2,-6.1) -- node[midway,above] {Send request for single payment method} (19.8,-6.1);
    	\draw[solidarrow, txt]
    		(20.2,-6.1) -- (20.6,-6.1) -- node[midway,right] {Process payment request} (20.6,-7.6) -- (20.2,-7.6);
    	\draw[solidarrow, txt]
    		(20.2,-8.1) -- (20.6,-8.1) -- node[midway,right] {Send payment response} (20.6,-9.85) -- (20.2,-9.85);
      		\draw[dashedarrow, txt]
    			(19.8,-9.1) -- node[midway,above] {Payment successful} (10.2,-9.1);
    		\draw[dashedarrow,txt]
    			(19.8,-10.6) -- node[midway,above] {Payment failed} (10.6,-10.6);
    				\draw[solidarrow, txt]
    					(10.6,-13.1) -- node[midway,above] {Rollback previously successful \\ payment transaction} (19.8,-13.1);
    				\draw[solidarrow, txt]
    					(20.2,-13.1) -- (20.6,-13.1) -- node[midway,right] {Cancel previous \\ payment transaction} (20.6,-18.7) -- (20.2,-18.7);
    				\draw[solidarrow, txt]
    					(19.8,-18.7) -- node[midway,above] { } (10.8,-18.7);
    	\draw[dashedarrow,txt]
    		(10.2,-14.1) -- (10.6,-14.1) -- node[midway,right] {Pending payment request?} (10.6,-15.6) -- (10.2,-15.6);   	
    			\draw[dashedarrow]
    				(9.8,-15.5) -- (9.4,-15.5) -- node[left] {Yes (1 to n)} (9.4,-6.1) -- (9.8,-6.1);
    			\draw[dashedarrow]
    				(9.8,-15.7) -- (9.4,-15.7) -- node[left] {No} (9.4,-17.2) -- (9.8,-17.2);
    	\draw[solidarrow, txt]
    		(10.2,-17.2) -- (10.6,-17.2) -- node[midway,right] {Build response} (10.6,-18.7) -- (10.2,-18.7);
    	\draw[solidarrow, txt]
    		(9.8,-18.7) -- node[midway,above] {Multipayment response} (0.2,-18.7);
    		
\end{tikzpicture}
\end{document}