% Document Header
\documentclass[tikz,border=12pt,12pt]{standalone}
\hyphenpenalty=10000
\input{style/new_sequence.tikz}
\input{vars/shortcuts.tex}
\begin{document}
\begin{tikzpicture}

% Stage "consumer"
\node[participant] at (0,2) {Consumer};
\node[icon] (icon0) at (0,3.5) {\includegraphics[width=.1\textwidth] {consumer.png}};
\draw[aidline] (0, 0.15) -- (0,-20.4);

% Stage "merchant"
\node[participant] at (11,2) {Merchant};
\node[icon] (icon1) at (11,3.5) {\includegraphics[width=.1\textwidth] {merchant.png}};
\draw[aidline] (11, 0.15) -- (11,-20.4);

% Stage "payment"
\node[participant] at (22,2) {Payment Gateway};
\node[icon] (icon2) at (22,3.5) {\includegraphics[width=.1\textwidth] {paymentgateway.png}};
\draw[aidline] (22, 0.15) -- (22,-20.4);

% Stage "poipia"
\node[participant] at (33,2) {POI/PIA};
\node[align=center] at (33,0.75) {(on Hosted Payment Page)};
\node[icon] (icon3) at (33,3.5) {\includegraphics[width=.1\textwidth] {paymentprovider.png}};
\draw[aidline] (33, 0.15) -- (33,-20.4);

% Stage "fin"
\node[participant] at (44,2) {Financial Institution};
\node[icon] (icon4) at (44,3.5) {\includegraphics[width=.1\textwidth] {financialinstitution.png}};
\draw[aidline] (44, 0.15) -- (44,-20.4);

% Boxes
\draw[box, nightblue] (0,-0.25) -- (0,-1.25);
\draw[box, nightblue] (11,-0.65) -- (11,-3.35);
\draw[box, nightblue] (0,-3.15) -- (0,-7.1);
\draw[box, nightblue] (33,-6.9) -- (33,-12.1);
\draw[box, nightblue] (0,-9) -- (0,-10);
\draw[box, nightblue] (0,-11.5) -- (0,-12.5);
\draw[box, nightblue] (0,-14) -- (0,-15);
\draw[box, nightblue] (44,-14.4) -- (44,-17.1);
\draw[box, nightblue] (22,-16.9) -- (22,-19.6);
\draw[box, nightblue] (11,-19) -- (11,-20);

% Flows
% Flow "1 Initiates payment process"
\draw[solidarrow]
(0.21,-0.75) -- node[txt, midway,above] {1 Initiates payment process} (10.79,-0.75);
% Flow "2 Redirects to Hosted Payment Page"
\draw[solidarrow]
(10.79,-3.25) -- node[txt, midway,above] {2 Redirects to Hosted Payment Page} (0.21,-3.25);
% Flow "3 Selects payment method POI/PIA\\(can ask for invoice via email)"
\draw[solidarrow]
(0.21,-4.5) -- (0.61,-4.5) -- node[txt, midway,right] {3 Selects payment method POI/PIA\\(can ask for invoice via email)} (0.61,-5.75) -- (0.21,-5.75);
% Flow "4 Confirms payment"
\draw[solidarrow]
(0.21,-7) -- node[txt, midway,above] {4 Confirms payment} (32.79,-7);
% Flow "5 Sends invoice"
\draw[solidarrow]
(32.79,-9.5) -- node[txt, midway,above] {5 Sends invoice} (0.21,-9.5);
% Flow "6 Redirects to merchant"
\draw[solidarrow]
(32.79,-12) -- node[txt, midway,above] {6 Redirects to merchant} (0.21,-12);
% Flow "7 Initiates credit transfer consumer's bank"
\draw[solidarrow]
(0.21,-14.5) -- node[txt, midway,above] {7 Initiates credit transfer consumer's bank} (43.79,-14.5);
% Flow ""
\draw[solidarrow]
(43.79,-17) -- node[txt, midway,above] {} (22.21,-17);
% Flow "8 Deposits funds into merchant's bank account"
\draw[solidarrow]
(22.21,-18.25) -- (22.61,-18.25) -- node[txt, midway,right] {8 Deposits funds into merchant's bank account} (22.61,-19.5) -- (22.21,-19.5);
% Flow "9 Sends notification"
\draw[solidarrow]
(21.79,-19.5) -- node[txt, midway,above] {9 Sends notification} (11.21,-19.5);

% Document Footer
\end{tikzpicture}
\end{document}
