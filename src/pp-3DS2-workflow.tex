% Preamble
\documentclass[tikz,border=12pt,12pt]{standalone}
\input{style/sequence.tikz}
\input{vars/shortcuts.tex}

\begin{document}
\begin{tikzpicture}

% Body
  % Participants
  \node[pt2] at (-5,1) {Consumer};
  	\node[icon] (icon1) at (-5,2.5)
       {\includegraphics[width=.1\textwidth]{useralt.png}};
   \node[pt1] at (5,1) {Merchant System};
       \node[icon] (icon2) at (5,2.5)
            {\includegraphics[width=.1\textwidth]{retailers.png}};
    \node[pt3] at (15,1) {Payment Gateway};
       \node[icon] (icon3) at (15,2.5)
            {\includegraphics[width=.1\textwidth]{gear.png}};
     \node[pt4] at (25,1.5) {Wirecard 3DS Router (Public Endpoint)};
        \node[icon] (icon4) at (25,2.5)
             {\includegraphics[width=.1\textwidth]{intgsolutions.png}};
                      
 			 % Aid Lines
  			\draw[line_night] (-5,0) -- (-5,-19.5);
  			\draw[line_mulberry] (5,0) -- (5,-19.5);
 			\draw[line_nightsky] (15,0) -- (15,-19.5);
  			\draw[line_sky] (25,0) -- (25,-19.75);
  
                      % Nodes
                      \fill[night] (-5.1,-.75) rectangle (-4.9,-1.25);
                      \fill[mulberry] (5.1,-0.9) rectangle (4.9,-1.6);
                      \fill[nightsky] (15.1,-1.4) rectangle (14.9,-3.1);
                      \fill[mulberry] (5.1,-2.9) rectangle (4.9,-3.6);
                      \fill[night] (-5.1,-3.4) rectangle (-4.9,-6.6);
                      \fill[sky] (25.1,-4.9) rectangle (24.9,-6.6);
                      \fill[sky] (25.1,-8) rectangle (24.9,-8.5);
                      \fill[night] (-4.9,-8.15) rectangle (-5.1,-12.6);
                      \fill[sky] (25.1,-12.4) rectangle (24.9,-14.1);
                      \fill[night] (-4.9,-13.9) rectangle (-5.1,-15.6);
                      \fill[mulberry] (5.1,-15.4) rectangle (4.9,-16.1);
                      \fill[nightsky] (15.1,-16) rectangle (14.9,-17.5);
                      \fill[mulberry] (5.1,-19.1) rectangle (4.9,-17.4);
                      \fill[nightsky] (15.1,-18.75) rectangle (14.9,-19.25);


                      % Arrows & Text
                      \draw[solidarrow, txt]
                      (-4.8,-1) -- node[midway,above] {1.1 Checkout} (4.8,-1);
                      \draw[solidarrow, txt]
                      (5.2,-1.5) -- node[midway,above] {1.2 Check-enrollment} (14.8,-1.5);
                      \draw[solidarrow, txt]
                      (15.2,-1.7) -- (15.5,-1.7) -- node[midway, right] {1.3 Check the supported 3DS \\ version with 3DS Server} (15.5,-2.8) -- (15.2,-2.8);
                      \draw[solidarrow, txt]
                      (14.8,-3) -- node[midway,above] {1.4 Check-enrollment response} (5.2,-3);
                      \draw[dashedarrow, txt]
                      (4.8,-3.5) -- node[midway,above] {2.1 Initiating cardholder \\ POST HTTPS redirect} (-4.8,-3.5);
                      \draw[solidarrow, txt]
                      (-4.8,-5) -- node[midway,above] {2.1 POST HTTPS redirect} (24.8,-5);
                      \draw[solidarrow, txt]
                      (25.2,-5.2) -- (25.5,-5.2) -- node[midway, right] {2.2 Decodes PAReq} (25.5,-6.3) -- (25.2,-6.3);
                      \draw[dashedarrow, txt]
                      (24.8,-6.5) -- node[midway,above] {2.3 POST HTML redirect} (-4.8,-6.5);
                      \draw[dashedarrow, txt]
                      (24.8,-8.25) -- node[midway,above] {2.4 Redirect cardholder to 3DSMethodURL for device fingerprinting} (-4.8,-8.25);
                      \draw[solidarrow, txt]
                      (-4.8,-9.7) -- (-4.6,-9.7) -- node[midway, right] {2.5 Issuer ACS executes \\ information gathering} (-4.6,-10.8) -- (-4.8,-10.8);
                      \draw[solidarrow]
                      (-4.8,-12.5) -- node[midway,above] {2.5 3DS method completion} (24.8,-12.5);
                      \draw[solidarrow, txt]
                      (25.2,-12.7) -- (25.5,-12.7) -- node[midway, right] {2.6 Initiate \\ authentication flow} (25.5,-13.8) -- (25.2,-13.8);
                      \draw[dashedarrow, txt]
                      (24.8,-14) -- node[midway,above] {2.7 Authentication response} (-4.8,-14);
                      \draw[solidarrow, txt]
                      (-4.8,-15.5) -- node[midway,above] {2.7 Redirect through cardholder \\ browser to termURL} (4.8,-15.5);
                      \draw[solidarrow, txt]
                      (5.2,-16) -- node[midway,above] {3.1 Check-payer-response} (14.8,-16);
                      \draw[solidarrow, txt]
                      (15.2,-16.2) -- (15.5,-16.2) -- node[midway, right] {3.2 Decode PARes} (15.5,-17.3) -- (15.2,-17.3);
                      \draw[dashedarrow, txt]
                      (14.8,-17.5) -- node[midway,above] {3.3 Check-payer-response response} (5.2,-17.5);
                      \draw[solidarrow, txt]
                      (5.2,-19) -- node[midway,above] {4.1 Authorization or purchase} (14.8,-19);

\end{tikzpicture}
\end{document}
